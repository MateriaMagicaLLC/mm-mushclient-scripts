<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Thursday, May 08, 2014, 1:11 PM -->
<!-- MuClient version 4.91 -->

<!-- Plugin "comm_stuff" generated by Plugin Wizard -->

<muclient>

<plugin
   name="comm_stuff"
   author="Ruthgul"
   id="51a661f409c5d66601ff16e9"
   language="Lua"
   purpose="Lets you send messages and share data over IRC"
   save_state="y"
   date_written="2014-05-08 13:10:06"
   date_modified="2014-05-27 18:46:33"
   requires="4.71"
   version="1.0"
   >

<description trim="y">

<![CDATA[

.--------------.
 | comm_stuff |
`--------------'

A way to send messages, and share affects and GMCP vitals, over IRC.
Broadcasts the received data, to be processed by other plugins (capture2dworld, events_mini, vitals_bars, pending some changes.)


** REQUIRES **
- MM_GMCP_Handler (plugin id="f67c4339ed0591a5b010d05b") must be installed and enabled.
- The file generic_miniwindow.lua must be placed in the MUSHclient/lua directory.
- MUSHclient must have write access to its folder.


Syntax:

> Chat:

* // msg <#channel_or_user> <msg>  - sends a message to a channel or another user  (eg: //msg #ragnarok hello)

> Connect / disconnect manually:

* // connect  - connects to the default IRC server
* // disconnect  - disconnects from IRC

> Channels:

* // join <#channel>  - joins an IRC channel  (eg: //join #ragnarok)
* // leave <#channel>  - leaves an IRC channel

> Configuration:

* // server <server_name>  - changes the default server  (eg: //server us.undernet.org)
* // port <port_number>  - changes the default port number
* // channel <#channel_name>  - changes the default channel, which isused to relay vitals and affects  (eg: //channel #ragnarok)

> Toggles:

* share vitals  - toggles auto-sharing your GMCP char.vitals packets on IRC (ON by default)
* share affects  - toggles auto-sharing your affects on IRC (OFF by default)

* show vitals  - toggles showing received vitals in the IRC mini (OFF by default)
* show affects  - toggles showing received affects in the IRC mini (OFF by default)

> Miniwindow:

* irc mini [on|off]  - shows/hides the IRC miniwindow
* clear irc mini - clears the miniwindow contents


Plugin created by Ruthgul
IRC code written by Alicia Konnen
Miniwindow code written by Fiendish and Enelya

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts


]]>

</description>

</plugin>



<!--  Aliases -->

<aliases>

<!-- IRC -->
<!-- chat -->

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*msg[ ]+(?P&lt;recipient&gt;[^ ]+)[ ]+(?P&lt;msg&gt;.+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>irc_message("%&lt;recipient&gt;", "%&lt;msg&gt;")
</send>
  </alias>

<!-- actions don't work, due to a weird issue with CTCP, so this alias is disabled -->
  <alias
   keep_evaluating="y"
   match="^\/\/[ ]*me[ ]+(?P&lt;recipient&gt;[^ ]+)[ ]+(?P&lt;msg&gt;.+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>irc_action("%&lt;recipient&gt;", "%&lt;msg&gt;")
</send>
  </alias>

<!-- connect / disconnect -->

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*connect$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>irc_connect()
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*disconnect$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>irc_disconnect()
</send>
  </alias>

<!-- channels -->

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*join[ ]+(?P&lt;channel&gt;\#[^ ]+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>irc_join("%&lt;channel&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*leave[ ]+(?P&lt;channel&gt;\#[^ ]+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>irc_leave("%&lt;channel&gt;")
</send>
  </alias>

<!-- config -->

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*server[ ]+(?P&lt;server&gt;[^ ]+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>set_irc_server("%&lt;server&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*port[ ]+(?P&lt;port&gt;[0-9]+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>set_irc_port("%&lt;port&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^\/\/[ ]*channel[ ]+(?P&lt;channel&gt;\#[^ ]+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>set_irc_channel("%&lt;channel&gt;")
</send>
  </alias>

<!-- toggles -->

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^share[ ]+vitals(| (?P&lt;status&gt;(on|off)))$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_share_vitals("%&lt;status&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^share[ ]+affects(| (?P&lt;status&gt;(on|off)))$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_share_affects("%&lt;status&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^show[ ]+vitals(| (?P&lt;status&gt;(on|off)))$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_show_vitals("%&lt;status&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   keep_evaluating="y"
   match="^show[ ]+affects(| (?P&lt;status&gt;(on|off)))$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_show_affects("%&lt;status&gt;")
</send>
  </alias>

<!-- miniwindow -->

  <alias
   match="^irc mini(| (?P&lt;status&gt;(on|off)))$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_mini_to("%&lt;status&gt;")
</send>
  </alias>

  <alias
   match="^clear irc mini$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>clear_mini()
</send>
  </alias>


<!--  Plugin help  -->

  <alias
   enabled="y"
   match="^comm\_stuff(|( |\:)help)$"
   regexp="y"
   script="OnHelp"
  >
  </alias>

</aliases>



<!--  Triggers  -->

<triggers>

<!-- on first prompt -->

  <trigger
   name="first_prompt"
   keep_evaluating="y"
   match="^(|[^ ]+(.*?))(\&lt;(.+)hp (.+)sp (.+)st\&gt;|\(.+\)|\&gt;) $"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>on_first_prompt()
</send>
  </trigger>

</triggers>



<!--  Scripts  -->

<script>

<![CDATA[

require "generic_miniwindow"
require "serialize"


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  Tell("-- " .. GetPluginInfo(GetPluginID(), 1) .. ": type ")
  ColourTell("silver", "black", GetPluginInfo(GetPluginID(), 1) .. " help")
  Note(" to see info about this plugin --")

  load_config()
  init_stuff()
end


function OnPluginConnect()
  init_stuff()
end


function OnPluginDisconnect()
  --uncomment the next line to also disconnect from IRC when we disconnect from the world
  --irc_disconnect()
end


function OnPluginEnable()
  if (show_mini) then
    mini_show()
  end
end


function OnPluginClose()
  if (show_mini) then
    if GetPluginInfo(GetPluginID(), 17) then -- plugin is enabled
      mini_hide()
    end
  end
end


function OnPluginDisable()
  if (show_mini) then
    mini_hide()
  end
end


function OnPluginSaveState()
  if (show_mini) then
    SetVariable("enabled", tostring(GetPluginInfo(GetPluginID(), 17)))
    save_status()
  end
end


function OnHelp()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID(), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo(GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/comm_stuff.xml",
  }
  return (table.concat(t, ";"))
end


function plugin_update_aux_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/generic_miniwindow.lua,MUSH/lua",
  }
  return (table.concat(t, ";"))
end



-----------
-- config
-----------

idebug = false

fg_col = "silver"
bg_col = "black"

default_network = "irc.efnet.org"
--default_network = "irc.quakenet.org" -- doesn't let me join a channel
--default_network = "us.undernet.org" -- doesn't let me join a channel

default_port = 6667
default_channel = "#myMMtest"
display_motd = true


function init_stuff()
  EnableTrigger("first_prompt", true)

  my_name = nil
  prev_time = os.time()

  -- debug
--  my_name = "yerrnickhere"

  if (isIRCConnected()) then
    irc_disconnect()
  end
end


function load_config()
  irc_network = GetVariable("irc_network") or default_network
  irc_port = tonumber(GetVariable("irc_port") or default_port)
  irc_channel = GetVariable("irc_channel") or default_channel

  if (idebug) then
    share_vitals = true
    share_affects = true
    show_vitals = true
    show_affects = true
    show_mini = true

  else
    share_vitals = ((GetVariable("share_vitals") or "true") == "true")
    share_affects = ((GetVariable("share_affects") or "false") == "true")
    show_vitals = ((GetVariable("show_vitals") or "false") == "true")
    show_affects = ((GetVariable("show_affects") or "false") == "true")
    show_mini = ((GetVariable("show_mini") or "true") == "true")
  end

  init_mini()
end


function save_config()
  SetVariable("irc_network", irc_network)
  SetVariable("irc_port", irc_port)
  SetVariable("irc_channel", irc_channel)
  SetVariable("share_vitals", tostring(share_vitals))
  SetVariable("share_affects", tostring(share_affects))
  SetVariable("show_vitals", tostring(show_vitals))
  SetVariable("show_affects", tostring(show_affects))
  SetVariable("show_mini", tostring(show_mini))
  SaveState()
end


function toggle_share_vitals(status)
  share_vitals = do_toggle(share_vitals, status)

  save_config()

  if (share_vitals) then
    ColourNote(fg_col, bg_col, "-- comm_stuff: sharing GMCP vitals over IRC is now ON --")
  else
    ColourNote(fg_col, bg_col, "-- comm_stuff: sharing GMCP vitals over IRC is now OFF --")
  end
end


function toggle_share_affects(status)
  share_affects = do_toggle(share_affects, status)

  save_config()

  if (share_affects) then
    ColourNote(fg_col, bg_col, "-- comm_stuff: sharing affects over IRC is now ON --")
  else
    ColourNote(fg_col, bg_col, "-- comm_stuff: sharing affects over IRC is now OFF --")
  end
end


function toggle_show_vitals(status)
  show_vitals = do_toggle(show_vitals, status)

  save_config()

  if (show_vitals) then
    ColourNote(fg_col, bg_col, "-- comm_stuff: showing vitals in the IRC mini is now ON --")
  else
    ColourNote(fg_col, bg_col, "-- comm_stuff: showing vitals in the IRC mini is now OFF --")
  end
end


function toggle_show_affects(status)
  show_affects = do_toggle(show_affects, status)

  save_config()

  if (show_affects) then
    ColourNote(fg_col, bg_col, "-- comm_stuff: showing affects in the IRC mini is now ON --")
  else
    ColourNote(fg_col, bg_col, "-- comm_stuff: showing affects in the IRC mini is now OFF --")
  end
end


function do_toggle(var, status)
  if (status == "on") then
    var = true
  elseif (status == "off") then
    var = false
  else
    var = not var
  end

  return var
end


function set_irc_server(server)
  irc_network = server

  save_config()

  ColourNote(fg_col, bg_col, "-- comm_stuff: IRC default server changed to " .. server .. " - you'll need to reconnect to start using the new network --")
end


function set_irc_port(port)
  irc_port = tonumber(port)

  save_config()

  ColourNote(fg_col, bg_col, "-- comm_stuff: IRC default port changed to " .. num .. " - you'll need to reconnect to start using the new port --")
end


function set_irc_channel(channel)
  irc_channel = channel

  save_config()

  ColourNote(fg_col, bg_col, "-- comm_stuff: IRC default channel changed to " .. channel .. " - you'll need to //join " .. channel .. " to start using it --")
end



-------------------
-- name detection
-------------------

function on_first_prompt()
  wait.make(function()
    EnableTrigger("first_prompt", false)

    -- give the plugins time to initialize
    wait.time(3)

    do_get_name()
  end)
end


function do_get_name()
  my_name = get_global_var("name")

  if (my_name) then
    got_name()
  end
end


function got_name()
  irc_connect()
end



-------------------------
-- GMCP and global_vars
-------------------------

function OnPluginBroadcast(msg, id, pname, text)
  if (id =="97784abf5f30629a0d7e7307")
  and (pname == "global_vars") then -- global_vars
    if (msg == 1) and (text == "name") then
      -- name broadcasted
      do_get_name()
    end

  elseif (id == "f67c4339ed0591a5b010d05b") -- GMCP handler
  and (pname == "MM_GMCP_handler") then
    if (text == "char.vitals") then
      handle_vitals()
    elseif (text == "char.maxstats") then
      handle_maxvitals()
    end

  elseif (id =="6010f6bda5ebf2210998613d") -- affects_by_name
  and (pname == "affects_by_name")
  and (msg == 1) then
    handle_affects(text)
  end
end


function get_global_var(name)
  local res, val

  res, val = CallPlugin("97784abf5f30629a0d7e7307", "get_global_var", name)

  if (res ~= 0) then
    val = nil
  end

  return val
end


function get_gmcp_value(name)
  local res, val

  res, val = CallPlugin("f67c4339ed0591a5b010d05b", "gmcpval", name)

  if (res ~= 0) then
    val = nil
  elseif (val == "_empty") then
    val = nil
  end

  return val
end



-----------
-- vitals
-----------

min_time = 3

min_diff = {
  hp = 1,
  sp = 3,
  st = 8,
--  hp = 25,
--  sp = 100,
--  st = 250,
}

function handle_vitals()
  if (isIRCConnected()) and (share_vitals) then
    if (max_hp) and (max_sp) and (max_st) then
      if ((not prev_time) or ((os.time() - prev_time) > min_time)) then
        local hp = math.floor(tonumber(get_gmcp_value("char.vitals.hp") or 0) * 100 / max_hp)
        local sp = math.floor(tonumber(get_gmcp_value("char.vitals.sp") or 0) * 100 / max_sp)
        local st = math.floor(tonumber(get_gmcp_value("char.vitals.st") or 0) * 100 / max_st)

        if (idebug) then
          AppendToNotepad("IRC DEBUG", hp .. " " .. sp .. " " .. st .. "\r\n")
        end

        if (hp > 100) or (sp > 100) or (st > 100) then
          grab_maxes()

        else
          if (not prev_hp)
          or (math.abs(prev_hp - hp) > min_diff.hp)
          or (math.abs(prev_sp - sp) > min_diff.sp)
          or (math.abs(prev_st - st) > min_diff.st) then
            irc_message(irc_channel, "§vit§ " .. hp .. "," .. sp .. "," .. st)

            prev_hp = hp
            prev_sp = sp
            prev_st = st
          end
        end
      end
    end
  end
end


function grab_maxes()
  --only requesting maxes once per minute, top
  local frequency = 60

  if (not latest_maxes) or ((os.time() - latest_maxes) > frequency) then
    Execute("sendgmcp char.maxstats") -- request max vitals
    latest_maxes = os.time()
  end
end


function handle_maxvitals()
  max_hp = tonumber(get_gmcp_value("char.maxstats.maxhp") or 0)
  max_sp = tonumber(get_gmcp_value("char.maxstats.maxsp") or 0)
  max_st = tonumber(get_gmcp_value("char.maxstats.maxst") or 0)
end



------------
-- affects
------------

wanted_affects = {
  ["air invocation"] = true,
  ["blindness"] = true,
  ["confusion"] = true,
  ["deafen"] = true,
  ["detect illusion"] = true,
  ["energy orb"] = true,
  ["etheric pollution"] = true,
  ["extinction"] = true,
  ["fire invocation"] = true,
  ["impede movement"] = true,
  ["invisibility"] = true,
  ["levitation"] = true,
  ["paralysis"] = true,
  ["sanctuary"] = true,
  ["silence"] = true,
  ["stone curse"] = true,
  ["web"] = true,
}


function handle_affects(txt)
  wait.make(function()
    if (isIRCConnected()) and (share_affects) then
      local t = utils.split(txt, ";")

      local who = t[1]
      local affect = t[4]

      local stripped_affect = string.gsub(affect, " off$", "")

      if (idebug) then
        AppendToNotepad("IRC DEBUG", "who: " .. who .. " - aff: " .. affect .. " - strip_aff: " .. stripped_affect .. "\r\n")
      end

      if (string.lower(who) == "you") and (wanted_affects[string.lower(stripped_affect)]) then
        if (prev_time) and ((prev_time - os.time()) <= min_time) then
          wait.time(min_time)
        end

        irc_message(irc_channel, "§aff§ " .. affect)
      end
    end
  end)
end



------------
-- aliases
------------

function irc_connect()
  if (my_name) and (not isIRCConnected()) then
    ircNote("Connecting to " .. irc_network .. ":" .. irc_port .. "...")

    connectIRC(irc_network, irc_port)
  end
end


function irc_disconnect()
  if (isIRCConnected()) then
    sendIRCMessage("QUIT")
    disconnectIRC()
  end
end


function irc_join(channel)
  if (idebug) then
    AppendToNotepad("IRC DEBUG", "trying to join channel " .. channel .. "\r\n")
  end

  if (isIRCConnected()) then
    if (idebug) then
      AppendToNotepad("IRC DEBUG", "we're connected - sending JOIN\r\n")
    end
    sendIRCMessage("JOIN " .. channel)
  end
end


function irc_leave(channel)
  if (isIRCConnected()) then
    sendIRCMessage("PART " .. channel)
  end
end


function irc_message(recipient, msg)
  if (isIRCConnected()) and (recipient ~= "") then
    msg = Trim(msg)

    sendIRCMessage("PRIVMSG " .. recipient .. " :" .. msg)

    local show_msg = true  -- check if we wanna echo vitals / affects
    if (string.match(msg, "^§vit§ %d+,%d+,%d+")) then  -- it's vitals
      show_msg = show_vitals
    elseif (string.match(msg, "^§aff§ %a+")) then  -- it's affects
      show_msg = show_affects
    end

    if (show_msg) then
      if (string.match(recipient, "#.+")) then  -- recipient is a channel
        ircNote("me@" .. recipient .. ": " .. msg, "PRIVMSG")
        BroadcastPlugin(1, "me;me@" .. recipient .. ";" .. msg)
      else  -- recipient is a user
        ircNote("me to " .. recipient .. ": " .. msg, "PRIVMSG")
        BroadcastPlugin(1, "me;me to " .. recipient .. ";" .. msg)
      end
    end
  end
end


function irc_action(recipient, msg)
  if (isIRCConnected()) and (recipient ~= "") then
    sendIRCMessage("PRIVMSG " .. recipient .. " :-CTCP-ACTION " .. msg .. "-CTCP-")

    if (string.match(recipient, "#.+")) then  -- recipient is a channel
      ircNote("me@" .. recipient .. ": * " .. my_name .. " " .. msg, "PRIVMSG")
    else  -- recipient is a user
      ircNote("me to " .. recipient .. ": * " .. my_name .." " .. msg, "PRIVMSG")
    end

    --sendIRCMessage("NOTICE " .. source .. " :-CTCP-TIME: " .. os.date() .. "-CTCP-")
  end
end



-----------------------------------------------
-- adapted from Lithium IRC, by Alicia Konnen
-----------------------------------------------

require "socket"
http = require "socket.http"

coroutines = {}
-- { thread = coroutine, onDeath = function }


function OnPluginTick()
	if (table.maxn(coroutines) ~= 0) then
		for _, y in ipairs(coroutines) do
			if (coroutine.status(y.thread) == "suspended") then
				coroutine.resume(y.thread)

      elseif (coroutine.status(y.thread) == "dead") then
				if (y.onDeath) and (type(y.onDeath) == "function") then
					y.onDeath()
				end

        table.remove(coroutines, i)
			end
		end
	end
end


ircrex = rex.new("^(?:[:@]([^\\s]+) )?([^\\s]+)(?: ((?:[^:\\s][^\\s]* ?)*))?(?: ?:(.*))?$")

irc_connection = nil


irc_fg_col = "silver"
irc_bg_col = "black"


function ircNote(msg, cmd)
	local str = ""

	if (not cmd) then
    add_to_mini(irc_fg_col, irc_bg_col, msg)

  else
		if (not irccommands[cmd]) then
			add_to_mini(irc_fg_col, irc_bg_col, msg)

		else
      add_to_mini(irccommands[cmd].fg or irc_fg_col, irccommands[cmd].bg or irc_bg_col, msg)
		end
	end
end


function disconnectIRC()
	if (irc_connection) then
    irc_connection:close()

    ircNote("IRC connection closed.")

    irc_connection = nil
  end
end


function connectIRC(serv, port)
	if (not irc_connection) then
    irc_connection = assert(socket.connect(serv, port))

    ircNote("Connected to " .. serv .. ":" .. port)

    irc_identified = nil
    local cor = coroutine.create(function() handleIRCClose(receiveIRC(irc_connection)) end)
    local tab = { thread = cor, onDeath = disconnectIRC }
    table.insert(coroutines, tab)
    prev_time = os.time()
  end
end


function connection_established()
  wait.make(function()
    wait.time(min_time)
    irc_join(irc_channel)
  end)
end


function joined_channel()
  grab_maxes()
end


function handleIRCClose(status)
  ircNote("Received close from IRC - " .. (status or "No error."))

	disconnectIRC()
end


function receiveIRC(conn)
	local status = "timeout"
	local d, r
	conn:settimeout(0)
	local message = ""

  while (status == "timeout") or ((status == nil) and (d ~= nil)) do
		d, status, r = conn:receive()

    if (d ~= nil) then
      message = message .. d
    end

    if (r ~= nil) then
      message = message .. r
    end

    if (message ~= "") then
			if (not irc_identified) then
        ircNote("Identifying as " .. my_name .. ":" .. string.reverse(my_name))
				sendIRCMessage(conn, "NICK " .. my_name)
				sendIRCMessage(conn, "USER " .. my_name .." 0 * :" .. string.reverse(my_name))
        irc_identified = true
			end

      handleIRCMessage(conn, message)
			message = ""
		end

    if (status == "timeout") then
			coroutine.yield(true)
		end
	end

  return status
end


function sendIRCMessage(conn, message)
	if (isIRCConnected()) then
    if (not message) then
      message = conn
      conn = irc_connection
    end

    local str = string.gsub(message, "\n", "")
    str = string.gsub(str, "\r", "")
    str = string.gsub(str, "%-CTCP%-", string.char(0x01))

    conn:send(str.." \r\n")
    prev_time = os.time()
  end
end


function isIRCConnected()
	if (irc_connection) then
		return true
	else
    return false
  end
end


function handleIRCMessage(conn, message)
  if (idebug) then
    AppendToNotepad("IRC DEBUG", message .. "\r\n")
  end

	local a, b, match = ircrex:match(message)

  if (a) and (b) then
    local source = match[1]
    local cmd = match[2]
    local target = match[3]
    local param = match[4]

    if (not cmd) then
      ircNote("MESSAGE ERROR: " .. message)
    else
      if (idebug) then
        AppendToNotepad("IRC DEBUG", "command: " .. cmd .. "\r\n")
      end
    end

    if (not irccommands[cmd]) then
      ircNote("UNKNOWN MESSAGE: " .. message)
    else
      irccommands[cmd].func(cmd, source, target, param, conn)
    end
  end
end


-- parsers

function parseNotice(cmd, source, target, param, conn)
  ircNote((source or "") .. ": " .. (param or ""), cmd)
end


function parseMOTD(cmd, source, target, param, conn)
	if (display_motd) then
    ircNote((param or ""), cmd)
  end
end


function endofMOTD(cmd, source, target, param, conn)
	if (display_motd) then
    ircNote((param or ""), cmd)
  end

  connection_established()
end


function parseNull(cmd, source, target, param, conn)
end


function parsePing(cmd, source, target, param, conn)
  if (param) then
		if (idebug) then
      AppendToNotepad("IRC DEBUG", "SENT: PONG :" .. param .. "\r\n")
    end
		sendIRCMessage(conn, "PONG " .. param)

  else
		if (idebug) then
      AppendToNotepad("IRC DEBUG", "SENT: PONG" .. "\r\n")
    end
		sendIRCMessage(conn, "PONG")
	end
end


function parseMode(cmd, source, target, param, conn)
	local str = ""

  if (not param) then
		target, param = string.match(target, "^(.-)%s+(.+)$")
	end

	if (string.find(target or "", "#") or string.find(target or "", "&")) then
		str = "(" .. target .. "): "
	end

	str = str .. "* " .. source .. " sets mode: " .. param

  ircNote(str, cmd)
end


function parseJoin(cmd, source, target, param, conn)
	local user, host = string.match(source, "^(.-)%!(.+)$")

  ircNote("(" .. param .. "): * " .. user .. " joins.", cmd)
end


function parsePart(cmd, source, target, param, conn)
	local user, host = string.match(source, "^(.-)%!(.+)$")

  ircNote("(" .. target .. "): * " .. user .. " leaves.", cmd)

  -- broadcast if the person left the default channel
  if (target == irc_channel) then
    local extuser = Trim(user) .. "@" .. Trim(target)
    BroadcastPlugin(1, Trim(user) .. ";" .. extuser .. ";§quit§")
  end
end


function parseNick(cmd, source, target, param, conn)
	local user, host = string.match(source, "^(.-)%!(.+)$")

  ircNote("* " .. user .. " is now known as " .. (param or target), cmd)
end


function parseQuit(cmd, source, target, param, conn)
	local user, host = string.match(source, "^(.-)%!(.+)$")

	local str = "* " .. user .. " quits"
  if (param) then
    str = str .. ": " .. param
  end

  -- broadcast if the person quit
  local extuser = Trim(user) .. "@" .. Trim(target)
  BroadcastPlugin(1, Trim(user) .. ";" .. extuser .. ";§quit§")

  ircNote(str, cmd)
end


function parseTopic(cmd, source, target, param, conn)
	local user, host = string.match(source, "^(.-)%!(.+)$")

	ircNote("(" .. target .. "): * " .. user .. " sets topic: " .. param, cmd)
end


function parsePrivmsg(cmd, source, target, param, conn)
	local user, host = string.match(source, "^(.-)%!(.+)$")
	local str = ""

  if (string.find(target or "", "#")) or (string.find(target or "", "&")) then
		str = "@" .. Trim(target)
  elseif (string.lower(Trim(target)) == string.lower(my_name)) then
    str = " to me"
  else
    str = " to " .. Trim(target)
  end
  local extuser = user .. str

  if (idebug) then
    AppendToNotepad("IRC DEBUG", "extuser: " .. extuser .. "\r\n")
  end

  if (string.find(param, string.char(0x01))) then
		if (string.find(param, "ACTION")) then
			local emote = param
			emote = string.gsub(emote, string.char(0x01) .. "ACTION", "")
			emote = string.gsub(emote, string.char(0x01), "")
			str = str .. " * " .. user .. emote

		elseif string.find(param, "TIME") then
			--sendIRCMessage("NOTICE " .. source .. " :-CTCP-TIME: " .. os.date() .. "-CTCP-")
			return

    else
			return
		end

  else
		str = user .. str .. ": " .. param
	end

  -- check if we wanna echo vitals / affects
  local show_msg = true
  if (string.match(param, "^§vit§ %d+,%d+,%d+")) then  -- it's vitals
    show_msg = show_vitals
  elseif (string.match(param, "^§aff§ %a+")) then  -- it's affects
    show_msg = show_affects
  end

  if (show_msg) then
    ircNote(Trim(str), cmd)
  end

  -- broadcast
  BroadcastPlugin(1, user .. ";" .. extuser .. ";" .. param)
end


function parseError(cmd, source, target, param, conn)
	ircNote("- ERROR: " .. param, cmd)
end


function parseCurrTopic(cmd, source, target, param, conn)
	target = string.match(target, "([#&][^%s,]+)%s-$")

  ircNote("(" .. target .. "): * Topic is '" .. param .. "'", cmd)
end


function parseNames(cmd, source, target, param, conn)
	target = string.match(target, "([#&][^%s,]+)%s-$")

	ircNote('(' .. target .. '): ' .. param, cmd)
end


function endofNames(cmd, source, target, param, conn)
	target = string.match(target, "([#&][^%s,]+)%s-$")

	ircNote('(' .. target .. '): ' .. param, cmd)

  joined_channel()
end


function parseErrCode(cmd, source, target, param, conn)
	if target then
		chan = string.match(target, "([#&][^%s,]+)%s-$")
	end

  local str = ""
	if (target) then
		str = '(' .. (chan or target) .. '): '
	end
  str = str .. "- " .. param .. ' [' .. cmd .. ']'

  ircNote(str, cmd)
end


irccommands = {
	["NOTICE"] = {
    func = parseNotice,
    fg = "springgreen",
  },
	["439"] = {
    func = parseNotice,
    fg = "springgreen",
  },
	["931"] = {
    func = parseNotice,
    fg = "springgreen",
  },
	["MODE"] = {
    func = parseMode,
    fg = "royalblue",
  },
	["PING"] = {
    func = parsePing,
    fg = "coral",
  },
	["JOIN"] = {
    func = parseJoin,
    fg = "royalblue",
  },
	["PART"] = {
    func = parsePart,
    fg = "royalblue",
  },
	["NICK"] = {
    func = parseNick,
    fg = "royalblue",
  },
	["QUIT"] = {
    func = parseQuit,
    fg = "royalblue",
  },
	["TOPIC"] = {
    func = parseTopic,
    fg = "royalblue",
  },
	["PRIVMSG"] = {
    func = parsePrivmsg,
  },
	["ERROR"] = {
    func = parseError,
    fg = "fuchsia",
  },
	["372"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["375"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["372"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["250"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["251"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["252"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["253"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["254"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["255"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["265"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["001"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["002"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["004"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["003"] = {
    func = parseMOTD,
    fg = "royalblue",
  },
	["376"] = {
    func = endofMOTD,
    fg = "royalblue",
  },
	["005"] = {
    func = parseNull,
  },
	["042"] = {
    func = parseNull,
  },
	["396"] = {
    func = parseNull,
  },
	["266"] = {
    func = parseNull,
  },
	["332"] = {
    func = parseCurrTopic,
    fg = "royalblue",
  },
	["333"] = {
    func = parseNull,
  },
	["353"] = {
    func = parseNames,
    fg = "royalblue",
  },
	["366"] = {
    func = endofNames,
    fg = "royalblue",
  },
	["401"] = {
    func = parseErrCode,
  },
	["402"] = {
    func = parseErrCode,
  },
	["403"] = {
    func = parseErrCode,
  },
	["404"] = {
    func = parseErrCode,
  },
	["405"] = {
    func = parseErrCode,
  },
	["406"] = {
    func = parseErrCode,
  },
	["407"] = {
    func = parseErrCode,
  },
	["409"] = {
    func = parseErrCode,
  },
	["411"] = {
    func = parseErrCode,
  },
	["412"] = {
    func = parseErrCode,
  },
	["413"] = {
    func = parseErrCode,
  },
	["414"] = {
    func = parseErrCode,
  },
	["421"] = {
    func = parseErrCode,
  },
	["422"] = {
    func = parseErrCode,
  },
	["423"] = {
    func = parseErrCode,
  },
	["424"] = {
    func = parseErrCode,
  },
	["431"] = {
    func = parseErrCode,
  },
	["432"] = {
    func = parseErrCode,
  },
	["433"] = {
    func = parseErrCode,
  },
	["436"] = {
    func = parseErrCode,
  },
	["441"] = {
    func = parseErrCode,
  },
	["442"] = {
    func = parseErrCode,
  },
	["443"] = {
    func = parseErrCode,
  },
	["444"] = {
    func = parseErrCode,
  },
	["445"] = {
    func = parseErrCode,
  },
	["446"] = {
    func = parseErrCode,
  },
	["451"] = {
    func = parseErrCode,
  },
	["461"] = {
    func = parseErrCode,
  },
	["462"] = {
    func = parseErrCode,
  },
	["463"] = {
    func = parseErrCode,
  },
	["464"] = {
    func = parseErrCode,
  },
	["465"] = {
    func = parseErrCode,
  },
	["467"] = {
    func = parseErrCode,
  },
	["471"] = {
    func = parseErrCode,
  },
	["472"] = {
    func = parseErrCode,
  },
	["473"] = {
    func = parseErrCode,
  },
	["474"] = {
    func = parseErrCode,
  },
	["475"] = {
    func = parseErrCode,
  },
	["481"] = {
    func = parseErrCode,
  },
	["482"] = {
    func = parseErrCode,
  },
	["483"] = {
    func = parseErrCode,
  },
	["491"] = {
    func = parseErrCode,
  },
	["501"] = {
    func = parseErrCode,
  },
	["502"] = {
    func = parseErrCode,
  },
}



---------------
-- miniwindow
---------------

function init_mini()
  if (show_mini) then
    do_install_miniwindow("irc", show_mini)
  end
end


function toggle_mini_to(status)
  show_mini = do_toggle(show_mini, status)

  save_config()

  if (show_mini) then
    mini_show()
  else
    mini_hide()
  end
end


function add_to_mini(fgcol, bgcol, txt)
  add_style_to_mini(fgcol, bgcol, txt)
  add_style_to_mini("silver", "black", "\r\n")
end


function add_style_to_mini(fgcol, bgcol, txt)
  if (not styles) then
    styles = {}
  end

  if (txt == "\r\n") then
    log_to_mini("", "", "", styles)
    styles = {}

  else
    styles[#styles + 1] = {
      text = txt,
      textcolour = ColourNameToRGB(fgcol),
      backcolour = ColourNameToRGB(bgcol),
      length = string.len(txt),
      style = 0,
    }
  end
end


]]>

</script>

</muclient>
